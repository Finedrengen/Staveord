
<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Staveordsspil</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --ink: #0f172a;
            --muted: #475569;
            --card: rgba(255, 255, 255, 0.9);
            --accent: #2563eb;
            --accent-2: #10b981;
            --shadow: 0 14px 40px rgba(15, 23, 42, 0.15);
            --border: rgba(148, 163, 184, 0.4);
        }

        body {
            margin: 0;
            font-family: "Trebuchet MS", "Segoe UI", Tahoma, sans-serif;
            background:
                radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.22), transparent 45%),
                radial-gradient(circle at 80% 10%, rgba(16, 185, 129, 0.18), transparent 40%),
                linear-gradient(140deg, #f8fafc 10%, #e2e8f0 55%, #f1f5f9 100%);
            color: var(--ink);
        }

        .container {
            display: flex;
            min-height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 18px;
            gap: 16px;
        }

        .game {
            flex: 2;
            padding: 24px;
            background: var(--card);
            border-radius: 18px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            position: relative;
            z-index: 1;
        }

        .sidebar {
            flex: 1;
            max-width: 380px;
            background: rgba(255, 255, 255, 0.95);
            padding: 24px;
            overflow: visible;
            border-radius: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            z-index: 2;
        }

        .sidebar-inner {
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }

        h1 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 2.2rem;
            letter-spacing: 0.01em;
        }

        #intro {
            margin-top: 0;
            margin-bottom: 16px;
            color: var(--muted);
            font-size: 1rem;
        }

        .card {
            background: #ffffff;
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
            margin-bottom: 16px;
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .image-wrapper {
            width: 100%;
            max-height: 320px;
            overflow: hidden;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(16, 185, 129, 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .emoji-icon {
            font-size: 120px;
            line-height: 1;
        }

        .audio-button {
            margin-top: 8px;
            border-radius: 9999px;
            border: none;
            padding: 6px 10px;
            background: #e2e8f0;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #334155;
        }

        .audio-button:hover {
            background: #cbd5f5;
        }

        .audio-button .icon {
            font-size: 16px;
        }

        #description {
            margin: 0;
            font-size: 1rem;
            color: #374151;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            margin-bottom: 8px;
        }

        label {
            width: 100%;
            font-size: 0.9rem;
            color: var(--muted);
        }

        input[type="text"],
        input[type="number"],
        select {
            flex: 1;
            min-width: 160px;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 1rem;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 1px #2563eb33;
        }

        button {
            border-radius: 6px;
            border: none;
            padding: 8px 14px;
            font-size: 0.95rem;
            cursor: pointer;
            font-weight: 500;
        }

        button:disabled {
            background: #9ca3af;
            cursor: default;
        }

        #check-button {
            background: var(--accent);
            color: #ffffff;
            box-shadow: 0 6px 14px rgba(37, 99, 235, 0.2);
        }


        #new-game-button {
            background: #0f766e;
            color: #ffffff;
            margin-left: 4px;
            box-shadow: 0 6px 14px rgba(15, 118, 110, 0.2);
        }

        #feedback,
        #sentence-feedback {
            min-height: 1.4em;
            font-weight: 500;
            margin-top: 4px;
        }

        #feedback.correct,
        #sentence-feedback.success {
            color: #15803d;
        }

        #feedback.incorrect,
        #sentence-feedback.error {
            color: #b91c1c;
        }

        .correct-word {
            color: #15803d;
            font-weight: 600;
        }

        #letter-slots {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            margin-bottom: 2px;
            padding: 6px 4px;
            border-radius: 10px;
            background: rgba(248, 250, 252, 0.9);
            border: 1px dashed rgba(148, 163, 184, 0.6);
        }

        #letter-slots:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        .letter-slot {
            min-width: 26px;
            padding: 6px 2px 2px;
            text-align: center;
            border-bottom: 2px solid #9ca3af;
            font-size: 1.1rem;
            font-weight: 500;
            color: #111827;
        }

        .letter-slot.filled {
            border-bottom-color: #2563eb;
        }

        #letter-feedback {
            min-height: 1.6em;
            margin-top: 4px;
            font-family: "Segoe UI", system-ui, sans-serif;
            letter-spacing: 0.06em;
        }

        #letter-feedback .correct {
            color: #15803d;
        }

        #letter-feedback .wrong {
            color: #b91c1c;
        }

        #letter-feedback .missing {
            color: #64748b;
        }

        #letter-feedback .extra {
            color: #f97316;
        }

        .hidden-input {
            position: absolute;
            opacity: 0;
            width: 1px;
            height: 1px;
            pointer-events: none;
        }

        .sentence-step h3 {
            margin: 0 0 8px 0;
            font-size: 1.2rem;
        }

        #sentence-input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #cbd5f5;
            font-size: 1rem;
            font-family: inherit;
            background: #ffffff;
        }

        #sentence-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        }

        .sentence-help {
            margin: 0 0 12px 0;
            color: #475569;
            font-size: 0.95rem;
            line-height: 1.45;
        }

        .sentence-preview {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            min-height: 48px;
            color: #0f172a;
        }

        .sentence-preview .error-word {
            color: #b91c1c;
            font-weight: 600;
            text-decoration: underline;
        }

        #sentence-errors,
        #sentence-tips,
        #sentence-definitions {
            margin: 10px 0 0 0;
            padding-left: 18px;
            color: #1f2937;
        }

        #sentence-errors li,
        #sentence-tips li,
        #sentence-definitions li {
            margin-bottom: 6px;
        }

        .suggestion-buttons {
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .suggestion-buttons button {
            background: #e2e8f0;
            color: #1f2937;
            padding: 4px 8px;
            font-size: 0.85rem;
        }

        .sentence-definitions {
            margin-top: 12px;
        }

        .sentence-definitions h4,
        .sentence-tips h4 {
            margin: 0 0 6px 0;
            font-size: 1rem;
            color: #0f172a;
        }

        .sentence-actions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        #sentence-check-button {
            background: #0ea5e9;
            color: #ffffff;
            box-shadow: 0 6px 14px rgba(14, 165, 233, 0.2);
        }

        #toggle-definitions {
            background: #e2e8f0;
            color: #1f2937;
            margin-top: 8px;
        }

        #progress, #attempts {
            margin-top: 4px;
            color: #4b5563;
            font-size: 0.95rem;
        }

        .sidebar h2 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.4rem;
        }

        #results-list {
            list-style: none;
            padding: 0;
            margin: 0 0 12px 0;
            font-size: 0.9rem;
        }

        #results-list li {
            padding: 6px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        #results-list li span.user {
            font-style: italic;
        }

        #results-list li.correct {
            color: #15803d;
        }

        #results-list li.incorrect {
            color: #b91c1c;
        }

        #score {
            font-weight: 600;
            margin-top: 8px;
        }

        .settings-card h3,
        .mastery-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .settings-toggle {
            border: none;
            background: #e2e8f0;
            color: #1f2937;
            width: 34px;
            height: 34px;
            padding: 0;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
        }

        .settings-toggle:hover {
            background: #cbd5f5;
        }

        .settings-body {
            display: none;
        }

        .settings-card.is-open .settings-body {
            display: block;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.92rem;
        }

        .setting-row label {
            width: auto;
            margin: 0;
            color: #1f2937;
        }

        .setting-group {
            margin-bottom: 12px;
        }

        .mastery-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }

        .mastery-list li {
            margin-bottom: 4px;
        }

        .info-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-left: 6px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #1f2937;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: default;
        }

        .info-tooltip .info-popover {
            position: absolute;
            top: 28px;
            right: 0;
            width: min(320px, 80vw);
            padding: 10px 12px;
            border-radius: 10px;
            background: #ffffff;
            color: #1f2937;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
            border: 1px solid rgba(148, 163, 184, 0.35);
            font-size: 0.9rem;
            line-height: 1.4;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-4px);
            transition: opacity 150ms ease, transform 150ms ease, visibility 150ms ease;
            z-index: 5;
        }

        .info-tooltip:hover .info-popover,
        .info-tooltip:focus-within .info-popover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .streak {
            margin-top: 8px;
            font-weight: 600;
            color: #0f766e;
        }

        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                max-width: none;
                border-left: none;
                border-top: 1px solid #e5e7eb;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <main class="game">
        <h1>Staveordsspil</h1>
        <p id="intro">
            Der vises et ikon og en kort forklaring. Skriv det danske ord, der passer til ikonet og forklaringen.
            Der er 10 ord pr. spil. Du har tre forsøg pr. ord.
        </p>

        <section class="card">
            <div class="image-wrapper">
                <div id="emoji" class="emoji-icon" aria-hidden="true"></div>
            </div>
            <p id="description"></p>
            <button id="audio-button" class="audio-button" type="button" aria-label="L&aelig;s ordet op">
                <span class="icon">&#128266;</span>
                L&aelig;s ordet op
            </button>
        </section>

        <form id="answer-form">
            <label for="answer-input">Skriv ordet ved at taste (tryk Enter eller "Tjek"):</label>
            <input id="answer-input" class="hidden-input" type="text" autocomplete="off" spellcheck="false" aria-label="Indtast ordet">
            <div id="letter-slots"></div>
            <button type="submit" id="check-button">Tjek</button>
            <button type="button" id="new-game-button" style="display:none;">Spil igen</button>
        </form>

        <p id="feedback"></p>
        <p id="letter-feedback"></p>
        <p id="progress"></p>
        <p id="attempts"></p>

        <section id="sentence-step" class="card sentence-step" style="display:none;">
            <h3>Brug ordet i en sætning</h3>
            <p class="sentence-help">
                Du skal skrive en sætning med ordet du lige har stavet til. Denne sætning skal være på mindst fire
                ord og hele sætningen skal være korrekt stavet. Hvis du har stavet noget forkert, bliver de forkerte
                ord markeret med rød. Du kan rette ordene og klikke på tjek igen. Du kan først fortsætte, når du har
                stavet helt korrekt.
            </p>
            <input id="sentence-input" type="text" spellcheck="true" lang="da" autocomplete="off">
            <div id="sentence-preview" class="sentence-preview"></div>
            <ul id="sentence-errors"></ul>
            <div class="sentence-tips">
                <h4>Tips</h4>
                <ul id="sentence-tips"></ul>
            </div>
            <button type="button" id="toggle-definitions">Vis forklaringer (valgfrit)</button>
            <div id="sentence-definitions-wrapper" class="sentence-definitions" style="display:none;">
                <h4>Forklaringer</h4>
                <ul id="sentence-definitions"></ul>
            </div>
            <div class="sentence-actions">
                <button type="button" id="sentence-check-button">Tjek sætning</button>
                <button type="button" id="sentence-next-button" disabled>Næste ord</button>
            </div>
            <p id="sentence-feedback"></p>
        </section>
    </main>

    <aside class="sidebar">
        <div class="sidebar-inner">
        <section class="card">
            <h2>Resultater</h2>
            <ul id="results-list"></ul>
            <p id="score"></p>
            <p id="streak" class="streak" style="display:none;"></p>
        </section>

        <section class="card mastery-card">
            <h3>
                Mestring
                <span class="info-tooltip" aria-label="Info om mestring" tabindex="0">
                    i
                    <span class="info-popover">
                        Her kan du se, hvilke ord du kan rigtig godt, og hvilke ord du skal &oslash;ve mere.
                        Ordene dukker op her, s&aring; du kan se, hvorfor spillet nogle gange giver dig bestemte ord igen.
                        Det hj&aelig;lper dig med at blive bedre til de sv&aelig;re ord.
                        "Skal &oslash;ves ofte" er de sv&aelig;re ord, som du skal &oslash;ve tit.
                        "Lidt bedre til", "Godt p&aring; vej" og "N&aelig;sten sikkert" er ord, du bliver bedre til.
                        "Kan sikkert" er ord, du kan rigtig godt, s&aring; de kommer kun en gang imellem.
                        Hold musen over ikonet for at se denne tekst.
                    </span>
                </span>
            </h3>
            <ul id="mastery-list" class="mastery-list"></ul>
            <p id="due-count"></p>
        </section>

        <section class="card settings-card" id="settings-card">
            <div class="settings-header">
                <h3>Forældreindstillinger</h3>
                <button type="button" id="settings-toggle" class="settings-toggle" aria-expanded="false" aria-controls="settings-body" title="Vis indstillinger">
                    &#9881;
                </button>
            </div>
            <div class="settings-body" id="settings-body">
            <div class="setting-group">
                <strong>Kategorier</strong>
                <div id="category-filters"></div>
            </div>
            <div class="setting-group">
                <strong>Sværhedsgrad</strong>
                <div class="setting-row">
                    <input type="checkbox" id="difficulty-easy">
                    <label for="difficulty-easy">Let</label>
                </div>
                <div class="setting-row">
                    <input type="checkbox" id="difficulty-medium">
                    <label for="difficulty-medium">Mellem</label>
                </div>
                <div class="setting-row">
                    <input type="checkbox" id="difficulty-hard">
                    <label for="difficulty-hard">Svær</label>
                </div>
            </div>
            <div class="setting-group">
                <strong>Hjælpemidler</strong>
                <div class="setting-row">
                    <input type="checkbox" id="setting-hint">
                    <label for="setting-hint">Tillad oplæsning af ord (koster point)</label>
                </div>
                <div class="setting-row">
                    <input type="checkbox" id="setting-slow">
                    <label for="setting-slow">Langsom oplæsning af ord</label>
                </div>
                <div class="setting-row">
                    <input type="checkbox" id="setting-streak">
                    <label for="setting-streak">Vis streak</label>
                </div>
            </div>
            </div>
        </section>
        </div>
    </aside>
</div>

<script>
    const TOTAL_ROUNDS_PER_GAME = 10;
    const MAX_ATTEMPTS = 3;
    const SETTINGS_KEY = "stavespil_settings";
    const STATS_KEY = "stavespil_stats";
    const DEF_CACHE_KEY = "stavespil_definitions";
    const POINTS_PER_ATTEMPT = [10, 7, 4];
    const LEITNER_INTERVALS_DAYS = [0.5, 2, 5, 12, 30];

    const emojiEl = document.getElementById("emoji");
    const descEl = document.getElementById("description");
    const answerInput = document.getElementById("answer-input");
    const letterSlotsEl = document.getElementById("letter-slots");
    const audioButton = document.getElementById("audio-button");
    const answerForm = document.getElementById("answer-form");
    const checkButton = document.getElementById("check-button");
    const newGameButton = document.getElementById("new-game-button");
    const feedbackEl = document.getElementById("feedback");
    const letterFeedbackEl = document.getElementById("letter-feedback");
    const progressEl = document.getElementById("progress");
    const attemptsEl = document.getElementById("attempts");
    const sentenceStepEl = document.getElementById("sentence-step");
    const sentenceInput = document.getElementById("sentence-input");
    const sentenceCheckButton = document.getElementById("sentence-check-button");
    const sentenceNextButton = document.getElementById("sentence-next-button");
    const sentencePreviewEl = document.getElementById("sentence-preview");
    const sentenceErrorsEl = document.getElementById("sentence-errors");
    const sentenceTipsEl = document.getElementById("sentence-tips");
    const toggleDefinitionsButton = document.getElementById("toggle-definitions");
    const sentenceDefinitionsWrapper = document.getElementById("sentence-definitions-wrapper");
    const sentenceDefinitionsEl = document.getElementById("sentence-definitions");
    const sentenceFeedbackEl = document.getElementById("sentence-feedback");
    const resultsListEl = document.getElementById("results-list");
    const scoreEl = document.getElementById("score");
    const streakEl = document.getElementById("streak");
    const masteryListEl = document.getElementById("mastery-list");
    const dueCountEl = document.getElementById("due-count");
    const settingsCardEl = document.getElementById("settings-card");
    const settingsToggleButton = document.getElementById("settings-toggle");
    const settingsBodyEl = document.getElementById("settings-body");
    const categoryFiltersEl = document.getElementById("category-filters");
    const difficultyEasyEl = document.getElementById("difficulty-easy");
    const difficultyMediumEl = document.getElementById("difficulty-medium");
    const difficultyHardEl = document.getElementById("difficulty-hard");
    const settingHintEl = document.getElementById("setting-hint");
    const settingSlowEl = document.getElementById("setting-slow");
    const settingStreakEl = document.getElementById("setting-streak");

    if (settingsCardEl && settingsToggleButton && settingsBodyEl) {
        settingsToggleButton.addEventListener("click", function () {
            const isOpen = settingsCardEl.classList.toggle("is-open");
            settingsToggleButton.setAttribute("aria-expanded", isOpen ? "true" : "false");
        });
    }

    let settings;
    let stats;
    let definitionCache;
    let currentGameWords = [];
    let baseWords = [];
    let baseIndex = 0;
    let baseCompleted = 0;
    let bonusQueue = [];
    let currentIsBonus = false;
    let totalCompleted = 0;
    let streakCount = 0;
    let currentWord = null;
    let attemptsLeft = MAX_ATTEMPTS;
    let currentAnswer = "";
    let currentMaxLength = 0;
    let needsCorrection = false;
    let hintUsed = false;
    let sentenceChecks = 0;
    let sentenceHadBlocking = false;
    let lastSpellcheckTime = 0;
    let currentResult = null;
    let lastSentenceMisspellings = [];
    let lastDefinitions = [];
    const WORD_GROUPS = [
    {
        id: "frugt",
        label: "Frugt & Grønt",
        words: [
            { word: "æble", clue: "Rund frugt med kernehus, ofte rød eller grøn.", emoji: "🍎", syllables: ["æ-ble"] },
            { word: "banan", clue: "Lang gul frugt med blødt indre, ofte spist som snack.", emoji: "🍌", syllables: ["ba-nan"] },
            { word: "orange", clue: "Rund citrusfrugt med tyk skræl og frisk saft.", emoji: "🍊" },
            { word: "pære", clue: "Frugt med blød form, bred forneden og smallere foroven.", emoji: "🍐" },
            { word: "gulerod", clue: "Afgrøde med stærk orange farve, vokser i jorden.", emoji: "🥕" },
            { word: "kartoffel", clue: "Rund eller oval rodfrugt, bruges ofte som tilbehør til aftensmad.", emoji: "🥔", syllables: ["kar-tof-fel"] },
            { word: "tomat", clue: "Rød rund grøntsag eller frugt, ofte brugt i salat og på pizza.", emoji: "🍅" },
            { word: "agurk", clue: "Lang grøn grøntsag med vandigt indre, bruges ofte i skiver.", emoji: "🥒" },
            { word: "salat", clue: "Grønne blade, som tit spises rå i en skål sammen med andre grøntsager.", emoji: "🥗" },
            { word: "broccoli", clue: "Grøntsag med mange små grønne toppe, ligner et lille træ.", emoji: "🥦" },
            { word: "blomme", clue: "Lille rund frugt med sten indeni og tynd skræl, kan være lilla eller gul.", emoji: "🍑" },
            { word: "melon", clue: "Stor frugt med grønt eller gult ydre og meget saftigt indre.", emoji: "🍉" },
            { word: "ananas", clue: "Tropisk frugt med pigget ydre og sød gul midte.", emoji: "🍍" },
            { word: "vindrue", clue: "Små runde bær, der ofte hænger i klaser på en gren.", emoji: "🍇" },
            { word: "citron", clue: "Gul citrusfrugt med meget sur saft.", emoji: "🍋" },
            { word: "jordbær", clue: "Lille rød frugt med små prikker udenpå, spises tit om sommeren.", emoji: "🍓" },
            { word: "hindbær", clue: "Lille rød bærfrugt med mange små dupper, vokser ofte på buske.", emoji: "🍓" },
            { word: "solbær", clue: "Små mørke bær med kraftig smag, bruges ofte i saft.", emoji: "🍇" },
            { word: "blåbær", clue: "Små mørkeblå bær, der farver fingrene.", emoji: "🫐" },
            { word: "peberfrugt", clue: "Hul grøntsag med tykke vægge, kan være rød, gul eller grøn.", emoji: "🫑" },
            { word: "løg", clue: "Rund ingrediens med mange lag, kan få øjne til at løbe i vand.", emoji: "🧅" },
            { word: "hvidløg", clue: "Lille hvid knold med stærk lugt, opdelt i fed.", emoji: "🧄" },
            { word: "porre", clue: "Lang grøn og hvid grøntsag, ofte brugt i supper.", emoji: "🧅" },
            { word: "spinat", clue: "Mørkegrønne blade, der ofte bruges i retter eller smoothies.", emoji: "🥬" },
            { word: "squash", clue: "Afgrøde som ligner en stor agurk, men ofte mørkegrøn eller gul.", emoji: "🥒" }
        ]
    },
    {
        id: "dyr",
        label: "Dyr",
        words: [
            { word: "kanin", clue: "Lille pelsdyr med lange ører, der ofte hopper.", emoji: "🐰" },
            { word: "hamster", clue: "Lille gnaver, som ofte bor i bur og løber i hjul.", emoji: "🐹" },
            { word: "fugl", clue: "Dyr med fjer og vinger, som kan sidde på grene.", emoji: "🐦" },
            { word: "hest", clue: "Stort dyr med manke, som mennesker ofte rider på.", emoji: "🐴" },
            { word: "gris", clue: "Lyserødt dyr med tryne, der ofte lever på gård.", emoji: "🐷" },
            { word: "giraf", clue: "Afrikansk dyr med meget lang hals og pletter.", emoji: "🦒" },
            { word: "elefant", clue: "Meget stort dyr med snabel og store ører.", emoji: "🐘", syllables: ["e-le-fant"] },
            { word: "tiger", clue: "Stribet rovdyr med orange pels og sorte striber.", emoji: "🐯" },
            { word: "zebra", clue: "Afrikansk dyr med sort-hvide striber over hele kroppen.", emoji: "🦓" },
            { word: "bjørn", clue: "Stort dyr med kraftig pels, som kan stå på bagben.", emoji: "🐻" },
            { word: "delfin", clue: "Intelligent havdyr, som ofte springer i bølgerne.", emoji: "🐬" },
            { word: "pingvin", clue: "Fuglelignende dyr der ikke flyver, men går sjovt og svømmer godt.", emoji: "🐧" },
            { word: "høne", clue: "Fugleart der lægger æg og ofte lever i hønsegård.", emoji: "🐔" },
            { word: "kylling", clue: "Ung fugl, ofte gul og dunet, kommer ud af æg.", emoji: "🐤" },
            { word: "andrik", clue: "Han-fugl med næb og ofte farverig fjerdragt ved søer.", emoji: "🦆" },
            { word: "kænguru", clue: "Dyr fra Australien, der har pung og hopper på bagben.", emoji: "🦘" },
            { word: "panda", clue: "Sort-hvidt bjørnedyr, som elsker bambus.", emoji: "🐼" },
            { word: "krokodille", clue: "Langt reptil med kraftige kæber, lever ved vandløb.", emoji: "🐊" },
            { word: "flodhest", clue: "Meget tungt dyr, der ofte ligger i vandløb og søer.", emoji: "🦛" },
            { word: "snegl", clue: "Lille dyr med hus på ryggen, bevæger sig langsomt.", emoji: "🐌" },
            { word: "edderkop", clue: "Lille skabning med otte ben, der kan lave spind.", emoji: "🕷️" },
            { word: "svale", clue: "Lille fugl, som ofte ses om sommeren flyve hurtigt.", emoji: "🐦" },
            { word: "måge", clue: "Hvid fugl med lange vinger, som ofte ses ved havet.", emoji: "🕊️" },
            { word: "hajfisk", clue: "Stort rovdyr i havet med mange skarpe tænder.", emoji: "🦈" },
            { word: "rævehvalp", clue: "Ung udgave af et rødt rovdyr med busket hale.", emoji: "🦊" }
        ]
    },
    {
        id: "toj",
        label: "Tøj",
        words: [
            { word: "trøje", clue: "Langærmet overdel af stof eller strik, bruges på overkroppen.", emoji: "👕" },
            { word: "jakke", clue: "Yderlag over overkroppen, bruges ofte udenfor.", emoji: "🧥" },
            { word: "bukser", clue: "Tøj til benene med to rør, holdes oppe i taljen.", emoji: "👖" },
            { word: "kjole", clue: "Stykke tøj i ét, der går ned over benene, ofte brugt af piger.", emoji: "👗" },
            { word: "skjorte", clue: "Overdel med krave og knapper foran.", emoji: "👔" },
            { word: "handske", clue: "Beklædning til hænder, med plads til fingre.", emoji: "🧤" },
            { word: "strømpe", clue: "Tøj til fødder og underben, bruges i sko.", emoji: "🧦" },
            { word: "støvle", clue: "Fodtøj der går op om anklen eller længere.", emoji: "👢" },
            { word: "sandaler", clue: "Åbent fodtøj med remme, bruges ofte om sommeren.", emoji: "🩴" },
            { word: "kasket", clue: "Hovedbeklædning med skygge foran.", emoji: "🧢" },
            { word: "frakke", clue: "Langt yderlag, der varmer kroppen i koldt vejr.", emoji: "🧥" },
            { word: "nederdel", clue: "Tøjstykke der dækker fra taljen og ned, men ikke benene helt rundt.", emoji: "👗" },
            { word: "tørklæde", clue: "Stofstykke om halsen, der både kan varme og pynte.", emoji: "🧣" },
            { word: "pyjamas", clue: "Sæt som bruges om natten, ofte blødt og behageligt.", emoji: "🛌" },
            { word: "badedragt", clue: "Tøj til kroppen, når man skal i vandet.", emoji: "🩱" },
            { word: "regnjakke", clue: "Overdel med hætte, der beskytter mod dråber fra himlen.", emoji: "🧥" },
            { word: "undertrøje", clue: "Tynd overdel der bæres inderst på kroppen.", emoji: "👕" },
            { word: "underbukser", clue: "Tøjstykke som bæres inderst omkring hofter og bagdel.", emoji: "🩲" },
            { word: "vest", clue: "Ærmeløs overdel, der kan være under eller over andet tøj.", emoji: "🦺" },
            { word: "sweater", clue: "Varm overdel af strik, der trækkes over hovedet.", emoji: "🧥" },
            { word: "skindjakke", clue: "Yderlag lavet af lædermateriale.", emoji: "🧥" },
            { word: "halstørklæde", clue: "Langt stykke stof viklet rundt om halsen i kulde.", emoji: "🧣" },
            { word: "flyverdragt", clue: "Heldragt, der holder kroppen varm om vinteren.", emoji: "🧥" },
            { word: "træningssæt", clue: "Sæt af overdel og bukser til motion.", emoji: "🏃" },
            { word: "regnbukser", clue: "Benklæder der beskytter mod vådt vejr.", emoji: "☔" }
        ]
    },
    {
        id: "hus",
        label: "Møbler & hus",
        words: [
            { word: "sofa", clue: "Møbel hvor flere personer kan sidde blødt i stuen.", emoji: "🛋️" },
            { word: "stol", clue: "Møbel til én person med ben og ryglæn.", emoji: "🪑" },
            { word: "bord", clue: "Flade på ben, hvor man kan stille ting eller spise.", emoji: "🍽️" },
            { word: "reol", clue: "Møbel med hylder, ofte fyldt med bøger.", emoji: "📚" },
            { word: "skab", clue: "Møbel med låger, hvor ting kan gemmes væk.", emoji: "🚪" },
            { word: "kommode", clue: "Møbel med skuffer til tøj eller andre småting.", emoji: "🧺" },
            { word: "seng", clue: "Møbel hvor man ligger ned om natten.", emoji: "🛏️" },
            { word: "natbord", clue: "Lille møbel ved siden af hovedgærdet med plads til lampe.", emoji: "🛌" },
            { word: "tæppe", clue: "Blødt lag på gulvet eller til at putte sig i.", emoji: "🧣" },
            { word: "pude", clue: "Blødt støtte til hovedet eller ryggen.", emoji: "😴" },
            { word: "lampe", clue: "Genstand der giver lys i rummet.", emoji: "💡" },
            { word: "gardin", clue: "Stof foran vinduer, der kan trækkes for.", emoji: "🪟" },
            { word: "spejl", clue: "Flade der viser dit eget ansigt tilbage.", emoji: "🪞" },
            { word: "toilet", clue: "Installationen man bruger, når man skal på wc.", emoji: "🚽" },
            { word: "bruser", clue: "Sted i badeværelset hvor vand falder ned på kroppen.", emoji: "🚿" },
            { word: "håndvask", clue: "Skålformet del i badeværelse eller køkken til at vaske hænder i.", emoji: "🚰" },
            { word: "ovn", clue: "Køkkenredskab der kan bage og stege ved høj varme.", emoji: "🍽️" },
            { word: "køleskab", clue: "Stor kasse i køkkenet med kold luft til madvarer.", emoji: "🧊" },
            { word: "fryser", clue: "Maskine der holder mad frossen og meget kold.", emoji: "🧊" },
            { word: "opvasker", clue: "Maskine der vasker tallerkener og glas automatisk.", emoji: "🍽️" },
            { word: "mikroovn", clue: "Køkkenapparat der varmer mad hurtigt med bølger.", emoji: "🔌" },
            { word: "dørmåtte", clue: "Ting man tørrer sko på lige indenfor indgangen.", emoji: "🚪" },
            { word: "skrivebord", clue: "Møbel med plads til computer og papirer.", emoji: "💻" },
            { word: "hylde", clue: "Smalt bræt på væggen til ting og pynt.", emoji: "📚" }
        ]
    },
    {
        id: "transport",
        label: "Transport",
        words: [
            { word: "lastbil", clue: "Stort køretøj med lad, som kan køre med varer.", emoji: "🚛" },
            { word: "cykel", clue: "Køretøj med pedaler, to hjul og styr.", emoji: "🚲" },
            { word: "motorcykel", clue: "Køretøj med motor og to hjul, man sidder overskrævs på.", emoji: "🏍️" },
            { word: "traktor", clue: "Køretøj der ofte arbejder på marken med store hjul.", emoji: "🚜" },
            { word: "skib", clue: "Stort fartøj der sejler på havet.", emoji: "🚢" },
            { word: "flyvemaskine", clue: "Stort fartøj med vinger, der kan færdes højt oppe.", emoji: "✈️" },
            { word: "helikopter", clue: "Luftfartøj med rotor på toppen, som kan stå stille i luften.", emoji: "🚁" },
            { word: "ubåd", clue: "Fartøj der kan dykke ned under vandoverfladen.", emoji: "🛥️" },
            { word: "busstoppested", clue: "Sted ved vejen hvor man venter på kollektivt køretøj.", emoji: "🚏" },
            { word: "lufthavn", clue: "Stort område hvor fly letter og lander.", emoji: "🛫" },
            { word: "motorvej", clue: "Bred vej hvor køretøjer kører hurtigt over lange stræk.", emoji: "🛣️" },
            { word: "taxa", clue: "Bil man kan betale for at blive kørt i.", emoji: "🚕" },
            { word: "færge", clue: "Skib der sejler biler og mennesker over vand.", emoji: "⛴️" },
            { word: "kano", clue: "Smalt fartøj, der roes med pagaj på sø eller å.", emoji: "🛶" },
            { word: "kajak", clue: "Lav båd hvor man sidder tæt på vandoverfladen og ror.", emoji: "🛶" },
            { word: "rulleskøjter", clue: "Fodtøj med hjul under, brugt til at glide på asfalt.", emoji: "🛼" },
            { word: "skateboard", clue: "Bræt med hjul under, som man står på og triller.", emoji: "🛹" },
            { word: "elbil", clue: "Køretøj på fire hjul, der bruger strøm i stedet for benzin.", emoji: "🚗" },
            { word: "knallert", clue: "Lille motoriseret to-hjulet, som ofte bruges af unge.", emoji: "🛵" },
            { word: "scooter", clue: "Lille motorcykel med trinbræt til fødderne.", emoji: "🛵" },
            { word: "brandbil", clue: "Køretøj fyldt med udstyr til at slukke ild.", emoji: "🚒" },
            { word: "politivogn", clue: "Køretøj med blå blink, der bruges af lovens repræsentanter.", emoji: "🚓" },
            { word: "ambulance", clue: "Køretøj der bringer syge og tilskadekomne hurtigt til hjælp.", emoji: "🚑" },
            { word: "kælkebane", clue: "Skrå område med sne, hvor man kan glide nedad.", emoji: "🛷" }
        ]
    },
    {
        id: "natur",
        label: "Natur",
        words: [
            { word: "skov", clue: "Område med mange træer og dyr.", emoji: "🌳" },
            { word: "strand", clue: "Sted med sand og vand, hvor man kan bade.", emoji: "🏖️" },
            { word: "mark", clue: "Stort åbent område, ofte med korn eller andre afgrøder.", emoji: "🌾" },
            { word: "eng", clue: "Grønt område med græs og blomster, hvor dyr kan græsse.", emoji: "🌼" },
            { word: "flod", clue: "Bred strøm af vand, der løber gennem landskab.", emoji: "🌊" },
            { word: "søbred", clue: "Området langs kanten af et stillestående vandområde.", emoji: "🏞️" },
            { word: "vulkan", clue: "Stor bjergform, hvor glødende sten kan komme ud.", emoji: "🌋" },
            { word: "regnskov", clue: "Område med tætte træer og meget nedbør, fyldt med liv.", emoji: "🌴" },
            { word: "klippe", clue: "Meget hård stenformation, ofte ved kyster eller bjerge.", emoji: "🪨" },
            { word: "stenstrand", clue: "Kystområde dækket af små og store klipper i stedet for sand.", emoji: "🪨" },
            { word: "regnbue", clue: "Farvestrimmel på himlen, som kan ses efter byger.", emoji: "🌈" },
            { word: "blomst", clue: "Plantedel med kronblade, ofte farverig og duftende.", emoji: "🌸" },
            { word: "blade", clue: "Flade grønne dele på grene, som falder af om efteråret.", emoji: "🍃" },
            { word: "gren", clue: "Del af træet, hvor mindre dele og løv sidder fast.", emoji: "🌿" },
            { word: "bjerge", clue: "Meget høje dele af landskab, ofte med sne på toppen.", emoji: "🏔️" },
            { word: "ørken", clue: "Stort område med meget lidt vand, ofte fyldt med sand.", emoji: "🏜️" },
            { word: "natursti", clue: "Smalt spor gennem landskab, hvor man kan gå på tur.", emoji: "🚶" },
            { word: "solskin", clue: "Vejr med klare stråler fra himmellegemet om dagen.", emoji: "☀️" },
            { word: "tordenvejr", clue: "Vejrtype med mørke skyer, bulder og lysglimt.", emoji: "⛈️" },
            { word: "snestorm", clue: "Kraftigt fald af hvide krystaller kombineret med blæst.", emoji: "🌨️" },
            { word: "frostgrader", clue: "Temperatur så lav, at vand bliver til is.", emoji: "❄️" },
            { word: "søndenvind", clue: "Luftstrøm der kommer nedefra på kortet.", emoji: "🌬️" },
            { word: "måneskin", clue: "Svagt lys fra nattehimmelens runde krop.", emoji: "🌙" },
            { word: "stjernehimmel", clue: "Natlig udsigt med mange lysprikker langt væk.", emoji: "🌌" },
            { word: "havbrise", clue: "Luftstrøm ind over land fra bølgefyldt område.", emoji: "🌊" }
        ]
    },
    {
        id: "sport",
        label: "Sport & fritid",
        words: [
            { word: "fodbold", clue: "Holdspil på græs med bold og mål.", emoji: "⚽" },
            { word: "håndbold", clue: "Indendørs holdsport, hvor man kaster bold mod net.", emoji: "🤾" },
            { word: "basket", clue: "Spil med kurv og bold, hvor man forsøger at ramme ring.", emoji: "🏀" },
            { word: "tennis", clue: "Spil med ketcher og bold på bane delt af net.", emoji: "🎾" },
            { word: "badminton", clue: "Ketcherspil med fjerbold på bane med net.", emoji: "🏸" },
            { word: "svømning", clue: "Aktivitet i vand, hvor man bevæger arme og ben.", emoji: "🏊" },
            { word: "cykling", clue: "Motion på køretøj med to hjul og pedaler.", emoji: "🚴" },
            { word: "teater", clue: "Sted hvor skuespillere optræder foran publikum.", emoji: "🎭" },
            { word: "maleri", clue: "Billede på lærred, ofte hængt op på væggen.", emoji: "🖼️" },
            { word: "dans", clue: "Bevægelse til musik, ofte i takt og mønstre.", emoji: "💃" },
            { word: "musik", clue: "Lyd med rytme og toner, der kan nydes af ørerne.", emoji: "🎵" },
            { word: "guitar", clue: "Instrument med strenge, som fingerspilles eller brug af plektre.", emoji: "🎸" },
            { word: "klaver", clue: "Instrument med tangenter, ofte brugt til melodi og akkorder.", emoji: "🎹" },
            { word: "trommer", clue: "Slaginstrumenter man slår på med køller eller hænder.", emoji: "🥁" },
            { word: "skakspil", clue: "Brætspil med brikker som konge, dronning og tårn.", emoji: "♟️" },
            { word: "hækling", clue: "Håndarbejde med garn og enkelt krogede redskab.", emoji: "🧶" },
            { word: "strikning", clue: "Håndarbejde hvor to redskaber bruges til at lave masker.", emoji: "🧶" },
            { word: "syarbejde", clue: "Arbejdsform hvor man samler stykker stof med nål og tråd.", emoji: "🧵" },
            { word: "fotografi", clue: "Billede taget med kamera.", emoji: "📷" },
            { word: "gaming", clue: "Aktivitet hvor man spiller elektroniske spil.", emoji: "🎮" },
            { word: "læsning", clue: "At sidde med bog eller tekst og følge bogstaverne.", emoji: "📖" },
            { word: "tegning", clue: "At lave streger og figurer på papir med blyant eller tusch.", emoji: "✏️" },
            { word: "brætspil", clue: "Spil på papplade med brikker eller kort, ofte omkring bordet.", emoji: "🎲" },
            { word: "rulleski", clue: "Udendørs aktivitet hvor man står på hjul under fødder og bruger stave.", emoji: "🎿" },
            { word: "trampolin", clue: "Stort hopperedskab i have eller hal, hvor man kan springe op og ned.", emoji: "🤸" }
        ]
    },
    {
        id: "jobs",
        label: "Jobs",
        words: [
            { word: "tømrer", clue: "Håndværker der arbejder med træ og bygger konstruktioner.", emoji: "🛠️" },
            { word: "snedker", clue: "Håndværker der laver møbler og fine detaljer i træ.", emoji: "🪚" },
            { word: "lærer", clue: "Person der underviser elever i klasselokale.", emoji: "👩‍🏫" },
            { word: "ingeniør", clue: "Fagperson der planlægger og udvikler tekniske løsninger.", emoji: "🧑‍💻" },
            { word: "læge", clue: "Person der undersøger patienter og giver behandling.", emoji: "🧑‍⚕️" },
            { word: "sygeplejerske", clue: "Person der hjælper patienter med pleje og medicin på hospital.", emoji: "🧑‍⚕️" },
            { word: "bager", clue: "Person der arbejder med dej og fremstiller brød og kager.", emoji: "👨‍🍳" },
            { word: "kok", clue: "Person der laver mad professionelt i køkken.", emoji: "👩‍🍳" },
            { word: "tjener", clue: "Person der serverer mad og drikke for gæster.", emoji: "🧑‍🍳" },
            { word: "chauffør", clue: "Person der kører køretøj og transporterer andre eller varer.", emoji: "🚗" },
            { word: "brandmand", clue: "Person der rykker ud til ild og redning.", emoji: "👨‍🚒" },
            { word: "politibetjent", clue: "Person der sørger for orden og sikkerhed i samfundet.", emoji: "👮" },
            { word: "advokat", clue: "Jurist der hjælper folk med regler og retssager.", emoji: "⚖️" },
            { word: "dommer", clue: "Person der afgør sager eller leder sportskampe.", emoji: "⚖️" },
            { word: "journalist", clue: "Person der finder og skriver nyheder.", emoji: "📰" },
            { word: "sekretær", clue: "Person der hjælper med møder, papirarbejde og telefoner.", emoji: "🧑‍💼" },
            { word: "fisker", clue: "Person der fanger dyr fra hav eller sø med båd eller stang.", emoji: "🎣" },
            { word: "bonde", clue: "Person der passer dyr og marker på landbrug.", emoji: "👩‍🌾" },
            { word: "gartner", clue: "Person der arbejder med planter, haver og parker.", emoji: "🌱" },
            { word: "mekaniker", clue: "Person der reparerer motorer og køretøjer.", emoji: "🔧" },
            { word: "skuespiller", clue: "Person der optræder i film, serier eller på scene.", emoji: "🎬" },
            { word: "musiker", clue: "Person der spiller instrumenter eller synger professionelt.", emoji: "🎵" },
            { word: "pilot", clue: "Person der styrer fly i luften.", emoji: "👨‍✈️" },
            { word: "forsker", clue: "Person der undersøger spørgsmål og laver forsøg for at finde viden.", emoji: "🔬" },
            { word: "arkitekt", clue: "Person der tegner bygninger og planlægger rum.", emoji: "🏗️" }
        ]
    },
    {
        id: "mad",
        label: "Mad & drikke",
        words: [
            { word: "pizza", clue: "Flad bund med tomatsovs, ost og fyld, bagt i ovn.", emoji: "🍕" },
            { word: "burger", clue: "Rund bolle med hakket kød og grønt imellem.", emoji: "🍔" },
            { word: "pasta", clue: "Italiensk basis af mel og vand, ofte formet som strenge eller skaller.", emoji: "🍝" },
            { word: "risret", clue: "Måltid hvor hvide korn er hovedingrediens.", emoji: "🍚" },
            { word: "suppe", clue: "Flydende ret i skål, spises ofte med ske.", emoji: "🥣" },
            { word: "sandwich", clue: "Mad med fyld mellem to skiver brød.", emoji: "🥪" },
            { word: "omelet", clue: "Ret lavet af piskede æg stegt på pande.", emoji: "🍳" },
            { word: "pandekage", clue: "Tynd rund kage stegt på pande, kan rulles sammen.", emoji: "🥞" },
            { word: "frikadelle", clue: "Lille formet kugle eller flad klump af stegt fars.", emoji: "🍖" },
            { word: "leverpostej", clue: "Smørepålæg lavet af kød, spises ofte på rugbrød.", emoji: "🥪" },
            { word: "rugbrød", clue: "Mørk fast brødtype, ofte skåret i skiver.", emoji: "🍞" },
            { word: "havregryn", clue: "Flager der ofte spises med mælk til morgenmad.", emoji: "🥣" },
            { word: "yoghurt", clue: "Tykt flydende mælkeprodukt, kan være med frugtstykker.", emoji: "🥛" },
            { word: "smoothie", clue: "Kold drik blendet af frugt, bær og væske.", emoji: "🥤" },
            { word: "chokoladekage", clue: "Sød bagt dessert med kakao, ofte pyntet.", emoji: "🍰" },
            { word: "isvaffel", clue: "Kegleformet kiks fyldt med frossen dessert.", emoji: "🍦" },
            { word: "milkshake", clue: "Kold drik af mælk og is, ofte med smag.", emoji: "🥤" },
            { word: "limonade", clue: "Sød drik med syrlig citrus-smag, serveres kold.", emoji: "🥤" },
            { word: "kakaomælk", clue: "Brun drik lavet af mælk og kakaopulver.", emoji: "🥛" },
            { word: "frugtsalat", clue: "Skål med mange slags stykker af søde planter.", emoji: "🍓" },
            { word: "grøntsagstærte", clue: "Bagt ret med bund og fyld af plantedele.", emoji: "🥧" },
            { word: "lasagne", clue: "Lagvis ret med plader, fyld og ost gratineret i ovn.", emoji: "🍝" },
            { word: "gryderet", clue: "Langtidskogt hovedmåltid i stor beholder på komfuret.", emoji: "🍲" },
            { word: "pølsemix", clue: "Servering med skiver af kødprodukt og kartoffelstave.", emoji: "🌭" },
            { word: "salatskål", clue: "Beholder fyldt med grønne blade og tilbehør.", emoji: "🥗" }
        ]
    }
];
const WORDS = buildWords();

    settings = loadSettings();
    stats = loadStats();
    definitionCache = loadDefinitionCache();

    initSettingsUI();
    updateMasteryUI();

    if (audioButton && "speechSynthesis" in window) {
        audioButton.addEventListener("click", function () {
            if (!currentWord) return;

            const text = currentWord.word;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "da-DK";
            if (settings.slowSpeech) {
                utterance.rate = 0.8;
            }
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);

            if (sentenceStepEl.style.display === "none") {
                answerInput.focus();
            }
        });
    } else if (audioButton) {
        audioButton.style.display = "none";
    }

    function buildWords() {
        const words = [];
        for (const group of WORD_GROUPS) {
            for (const entry of group.words) {
                const difficulty = entry.difficulty || deriveDifficulty(entry.word);
                const inferredTags = inferPatternTags(entry.word);
                const patternTags = Array.from(new Set([...(entry.patternTags || []), ...inferredTags]));
                words.push({
                    ...entry,
                    category: group.id,
                    categoryLabel: group.label,
                    difficulty,
                    patternTags: patternTags.length > 0 ? patternTags : ["basic"],
                    syllables: entry.syllables || null
                });
            }
        }
        return words;
    }

    function deriveDifficulty(word) {
        if (word.length <= 5) return "easy";
        if (word.length <= 8) return "medium";
        return "hard";
    }

    function inferPatternTags(word) {
        const tags = [];
        if (/[\u00e6\u00f8\u00e5]/i.test(word)) tags.push("aeoeaa");
        if (/(bb|dd|ff|gg|kk|ll|mm|nn|pp|rr|ss|tt)/i.test(word)) tags.push("double-consonant");
        if (word.length >= 10) tags.push("compound");
        if (/[y]/i.test(word)) tags.push("y");
        return tags;
    }
    function loadSettings() {
        const stored = localStorage.getItem(SETTINGS_KEY);
        if (stored) {
            try {
                return JSON.parse(stored);
            } catch (err) {
            }
        }
        const categories = {};
        for (const group of WORD_GROUPS) {
            categories[group.id] = true;
        }
        return {
            categories,
            difficulties: {
                easy: true,
                medium: true,
                hard: true
            },
            hintMode: false,
            slowSpeech: false,
            showDefinitions: false,
            showStreak: true
        };
    }

    function saveSettings() {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function loadStats() {
        const stored = localStorage.getItem(STATS_KEY);
        if (stored) {
            try {
                return JSON.parse(stored);
            } catch (err) {
            }
        }
        return {};
    }

    function saveStats() {
        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    }

    function loadDefinitionCache() {
        const stored = localStorage.getItem(DEF_CACHE_KEY);
        if (stored) {
            try {
                return JSON.parse(stored);
            } catch (err) {
            }
        }
        return {};
    }

    function saveDefinitionCache() {
        localStorage.setItem(DEF_CACHE_KEY, JSON.stringify(definitionCache));
    }

    function ensureStats(word) {
        if (!stats[word]) {
            stats[word] = {
                seenCount: 0,
                correctCount: 0,
                lastSeen: null,
                avgAttempts: 0,
                lastResult: "",
                box: 1,
                nextDue: 0
            };
        }
        return stats[word];
    }

    function initSettingsUI() {
        categoryFiltersEl.innerHTML = "";
        for (const group of WORD_GROUPS) {
            const row = document.createElement("div");
            row.className = "setting-row";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `cat-${group.id}`;
            checkbox.checked = !!settings.categories[group.id];
            checkbox.addEventListener("change", function () {
                settings.categories[group.id] = checkbox.checked;
                saveSettings();
            });
            const label = document.createElement("label");
            label.setAttribute("for", checkbox.id);
            label.textContent = group.label;
            row.appendChild(checkbox);
            row.appendChild(label);
            categoryFiltersEl.appendChild(row);
        }

        difficultyEasyEl.checked = settings.difficulties.easy;
        difficultyMediumEl.checked = settings.difficulties.medium;
        difficultyHardEl.checked = settings.difficulties.hard;

        difficultyEasyEl.addEventListener("change", function () {
            settings.difficulties.easy = difficultyEasyEl.checked;
            saveSettings();
        });
        difficultyMediumEl.addEventListener("change", function () {
            settings.difficulties.medium = difficultyMediumEl.checked;
            saveSettings();
        });
        difficultyHardEl.addEventListener("change", function () {
            settings.difficulties.hard = difficultyHardEl.checked;
            saveSettings();
        });

        settingHintEl.checked = settings.hintMode;
        settingSlowEl.checked = settings.slowSpeech;
        settingStreakEl.checked = settings.showStreak;

        settingHintEl.addEventListener("change", function () {
            settings.hintMode = settingHintEl.checked;
            saveSettings();
        });
        settingSlowEl.addEventListener("change", function () {
            settings.slowSpeech = settingSlowEl.checked;
            saveSettings();
        });
        settingStreakEl.addEventListener("change", function () {
            settings.showStreak = settingStreakEl.checked;
            updateStreakUI();
            saveSettings();
        });

        toggleDefinitionsButton.addEventListener("click", function () {
            settings.showDefinitions = !settings.showDefinitions;
            toggleDefinitionsButton.textContent = settings.showDefinitions
                ? "Skjul forklaringer"
                : "Vis forklaringer (valgfrit)";
            sentenceDefinitionsWrapper.style.display = "none";
            sentenceDefinitionsEl.innerHTML = "";
            saveSettings();
            if (settings.showDefinitions && currentWord) {
                updateDefinitions(currentWord.word, lastSentenceMisspellings);
            }
        });

        toggleDefinitionsButton.textContent = settings.showDefinitions
            ? "Skjul forklaringer"
            : "Vis forklaringer (valgfrit)";
        updateStreakUI();
    }

    function updateStreakUI() {
        if (settings.showStreak && streakCount > 0) {
            streakEl.style.display = "block";
            streakEl.textContent = `Streak: ${streakCount}`;
        } else {
            streakEl.style.display = "none";
        }
    }

    function updateMasteryUI() {
        const counts = [0, 0, 0, 0, 0];
        const wordsInBoxes = [[], [], [], [], []];
        const dueWords = [];
        const now = Date.now();
        let due = 0;

        for (const word of WORDS) {
            const info = ensureStats(word.word);
            const box = Math.min(Math.max(info.box || 1, 1), 5);
            counts[box - 1] += 1;
            wordsInBoxes[box - 1].push(word.word);
            if (info.nextDue && info.nextDue <= now) {
                due += 1;
                dueWords.push(word.word);
            }
        }

        masteryListEl.innerHTML = "";
        const masteryLabels = [
            "Skal øves ofte",
            "Lidt bedre til",
            "Godt på vej",
            "Næsten sikkert",
            "Kan sikkert"
        ];
        counts.forEach((count, index) => {
            const li = document.createElement("li");
            const list = wordsInBoxes[index].slice().sort((a, b) => a.localeCompare(b, "da-DK"));
            const label = masteryLabels[index] || `Boks ${index + 1}`;
            li.textContent = `${label}: ${count}`;
            li.title = list.length ? list.join(", ") : "Ingen ord endnu.";
            masteryListEl.appendChild(li);
        });
        dueCountEl.textContent = `Ord klar til gentagelse: ${due}`;
        const dueList = dueWords.slice().sort((a, b) => a.localeCompare(b, "da-DK"));
        dueCountEl.title = dueList.length ? dueList.join(", ") : "Ingen ord klar endnu.";
    }

    function shuffle(array) {
        const copy = [...array];
        for (let i = copy.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
    }

    function selectGameWords() {
        const now = Date.now();
        let eligible = WORDS.filter((word) =>
            settings.categories[word.category] && settings.difficulties[word.difficulty]
        );
        if (!eligible.length) {
            settings.categories = WORD_GROUPS.reduce((acc, group) => {
                acc[group.id] = true;
                return acc;
            }, {});
            settings.difficulties = { easy: true, medium: true, hard: true };
            saveSettings();
            initSettingsUI();
            eligible = WORDS;
        }

        const due = eligible.filter((word) => ensureStats(word.word).nextDue <= now);
        const newOrLow = eligible.filter((word) => {
            const s = ensureStats(word.word);
            return s.seenCount === 0 || s.box <= 2;
        });
        const remaining = eligible.filter(
            (word) => !due.includes(word) && !newOrLow.includes(word)
        );

        const pools = [shuffle(due), shuffle(newOrLow), shuffle(remaining)];
        const selected = [];
        let lastTags = [];

        while (selected.length < TOTAL_ROUNDS_PER_GAME && pools.some((pool) => pool.length)) {
            let picked = null;
            for (const pool of pools) {
                if (!pool.length) continue;
                const index = pool.findIndex((word) => !hasTagOverlap(word.patternTags, lastTags));
                const chosenIndex = index === -1 ? 0 : index;
                picked = pool.splice(chosenIndex, 1)[0];
                break;
            }
            if (!picked) {
                break;
            }
            selected.push(picked);
            lastTags = picked.patternTags;
        }

        if (selected.length < TOTAL_ROUNDS_PER_GAME) {
            const leftovers = eligible.filter((word) => !selected.includes(word));
            const fill = shuffle(leftovers).slice(0, TOTAL_ROUNDS_PER_GAME - selected.length);
            selected.push(...fill);
        }

        return selected;
    }

    function hasTagOverlap(tags, lastTags) {
        return tags.some((tag) => lastTags.includes(tag));
    }

    function scheduleMicroReview(word) {
        if (bonusQueue.some((entry) => entry.word.word === word.word)) {
            return;
        }
        const delay = 2 + Math.floor(Math.random() * 3);
        bonusQueue.push({ word, dueAfter: totalCompleted + delay });
    }

    function nextWord() {
        const dueBonus = bonusQueue.find((entry) => entry.dueAfter <= totalCompleted);
        if (dueBonus) {
            bonusQueue = bonusQueue.filter((entry) => entry !== dueBonus);
            currentIsBonus = true;
            return dueBonus.word;
        }

        if (baseIndex < baseWords.length) {
            currentIsBonus = false;
            const word = baseWords[baseIndex];
            baseIndex += 1;
            return word;
        }

        if (bonusQueue.length) {
            bonusQueue.sort((a, b) => a.dueAfter - b.dueAfter);
            currentIsBonus = true;
            return bonusQueue.shift().word;
        }

        return null;
    }

    function startGame() {
        baseWords = selectGameWords();
        baseIndex = 0;
        baseCompleted = 0;
        bonusQueue = [];
        totalCompleted = 0;

        resultsListEl.innerHTML = "";
        feedbackEl.textContent = "";
        feedbackEl.className = "";
        letterFeedbackEl.innerHTML = "";
        scoreEl.textContent = "Point: 0";
        streakCount = 0;
        updateStreakUI();

        newGameButton.style.display = "none";

        showCurrentWord();
    }

    function showCurrentWord() {
        const next = nextWord();
        if (!next) {
            endGame();
            return;
        }

        currentWord = next;
        attemptsLeft = MAX_ATTEMPTS;
        currentAnswer = "";
        hintUsed = false;
        needsCorrection = false;
        currentResult = null;
        sentenceChecks = 0;
        sentenceHadBlocking = false;
        lastSentenceMisspellings = [];
        lastDefinitions = [];

        const emojiValue = currentWord.emoji && !/^\?+$/.test(currentWord.emoji)
            ? currentWord.emoji
            : "❓";
        emojiEl.textContent = emojiValue;
        descEl.textContent = currentWord.clue;
        feedbackEl.textContent = "";
        feedbackEl.className = "";
        letterFeedbackEl.innerHTML = "";
        attemptsEl.textContent = `Forsøg tilbage: ${attemptsLeft}`;
        if (currentIsBonus) {
            progressEl.textContent = `Bonus-ord (efter ${baseCompleted} af ${TOTAL_ROUNDS_PER_GAME})`;
        } else {
            progressEl.textContent = `Ord ${baseCompleted + 1} af ${TOTAL_ROUNDS_PER_GAME}`;
        }

        showSpellingStep();
        setupLetterSlots(currentWord.word);
        answerInput.value = "";
        answerInput.maxLength = currentWord.word.length;
        answerInput.focus();
        checkButton.disabled = false;
    }

    function showSpellingStep() {
        answerForm.style.display = "flex";
        sentenceStepEl.style.display = "none";
        sentenceFeedbackEl.textContent = "";
        sentenceFeedbackEl.className = "";
    }

    function showSentenceStep() {
        answerForm.style.display = "none";
        sentenceStepEl.style.display = "block";
        sentenceInput.value = "";
        sentenceInput.setAttribute("lang", "da-DK");
        sentenceInput.setAttribute("spellcheck", "true");
        sentenceInput.spellcheck = true;
        sentenceFeedbackEl.textContent = "";
        sentenceFeedbackEl.className = "";
        sentencePreviewEl.textContent = "";
        sentenceErrorsEl.innerHTML = "";
        sentenceTipsEl.innerHTML = "";
        sentenceDefinitionsEl.innerHTML = "";
        sentenceDefinitionsWrapper.style.display = "none";
        lastSentenceMisspellings = [];
        lastDefinitions = [];
        sentenceNextButton.disabled = true;
        sentenceCheckButton.disabled = false;
        sentenceInput.focus();
    }

    function setupLetterSlots(word) {
        letterSlotsEl.innerHTML = "";
        for (let i = 0; i < word.length; i++) {
            const slot = document.createElement("span");
            slot.className = "letter-slot";
            slot.textContent = "";
            letterSlotsEl.appendChild(slot);
        }
        renderLetterSlots();
    }

    function renderLetterSlots() {
        const slots = letterSlotsEl.querySelectorAll(".letter-slot");
        for (let i = 0; i < slots.length; i++) {
            const ch = currentAnswer[i] || "";
            slots[i].textContent = ch;
            if (ch) {
                slots[i].classList.add("filled");
            } else {
                slots[i].classList.remove("filled");
            }
        }
    }

    function normalize(str) {
        return str.toLocaleLowerCase("da-DK").trim();
    }

    function normalizeChar(ch) {
        return ch ? ch.toLocaleLowerCase("da-DK") : "";
    }

    function showDiagnosticFeedback(userAnswer, correctWord) {
        letterFeedbackEl.innerHTML = "";
        const maxLen = Math.max(userAnswer.length, correctWord.length);

        for (let i = 0; i < maxLen; i++) {
            const span = document.createElement("span");
            const userChar = userAnswer[i];
            const correctChar = correctWord[i];

            if (userChar && correctChar) {
                if (normalizeChar(userChar) === normalizeChar(correctChar)) {
                    span.classList.add("correct");
                } else {
                    span.classList.add("wrong");
                }
                span.textContent = userChar;
            } else if (!userChar && correctChar) {
                span.classList.add("missing");
                span.textContent = "_";
            } else if (userChar && !correctChar) {
                span.classList.add("extra");
                span.textContent = userChar;
            }

            letterFeedbackEl.appendChild(span);
        }

        const hint = buildHint(userAnswer, correctWord);
        if (hint) {
            feedbackEl.textContent = hint;
        }
    }

    function buildHint(userAnswer, correctWord) {
        if (userAnswer.length < correctWord.length) {
            return "Der mangler et bogstav.";
        }
        if (userAnswer.length > correctWord.length) {
            return "Der er et ekstra bogstav.";
        }
        if (isSwapped(userAnswer, correctWord)) {
            return "To bogstaver er byttet rundt.";
        }
        if (isVowelIssue(userAnswer, correctWord)) {
            return "Tjek vokalerne (a, e, i, o, u, y, ø, ø, ø).";
        }
        return "Tjek bogstaverne igen.";
    }

    function isSwapped(userAnswer, correctWord) {
        for (let i = 0; i < userAnswer.length - 1; i++) {
            const swapped = userAnswer.split("");
            [swapped[i], swapped[i + 1]] = [swapped[i + 1], swapped[i]];
            if (normalize(swapped.join("")) === normalize(correctWord)) {
                return true;
            }
        }
        return false;
    }

    function isVowelIssue(userAnswer, correctWord) {
                const vowels = /[aeiouy\u00e6\u00f8\u00e5]/i;
        for (let i = 0; i < userAnswer.length; i++) {
            if (normalizeChar(userAnswer[i]) !== normalizeChar(correctWord[i])) {
                if (!(vowels.test(userAnswer[i]) && vowels.test(correctWord[i]))) {
                    return false;
                }
            }
        }
        return true;
    }

    function addResultRow(isCorrect, userAnswer) {
        const li = document.createElement("li");
        li.className = isCorrect ? "correct" : "incorrect";

        const roundNumber = baseCompleted + (currentIsBonus ? 0 : 1);
        const userSpan = document.createElement("span");
        userSpan.className = "user";
        userSpan.textContent = userAnswer || "(tomt svar)";

        const statusText = document.createElement("span");
        statusText.textContent = isCorrect ? " ?" : " ?";

        li.textContent = currentIsBonus ? "Bonus: " : `#${roundNumber}: `;
        li.appendChild(userSpan);
        li.appendChild(statusText);

        resultsListEl.appendChild(li);
    }

    function finalizeWord(isCorrect, finalAnswer, usedCorrection) {
        currentResult = {
            attemptsUsed: MAX_ATTEMPTS - attemptsLeft + 1,
            isCorrect,
            usedCorrection,
            hintUsed
        };

        addResultRow(isCorrect, finalAnswer);

        if (isCorrect && !usedCorrection) {
            const attemptsUsed = MAX_ATTEMPTS - attemptsLeft + 1;
            let points = POINTS_PER_ATTEMPT[Math.min(attemptsUsed - 1, POINTS_PER_ATTEMPT.length - 1)];
            if (hintUsed) {
                points = Math.max(0, points - 3);
            }
            const currentScore = Number(scoreEl.textContent.replace(/\D/g, "")) || 0;
            scoreEl.textContent = `Point: ${currentScore + points}`;
            feedbackEl.innerHTML =
                `Korrekt! Flot stavet: <span class="correct-word">${currentWord.word}</span>. ` +
                `Du fik ${points} point.`;
            feedbackEl.className = "correct";
        } else if (!isCorrect) {
            feedbackEl.innerHTML =
                `Der er fejl i ordet, og du har brugt alle tre forsøg. ` +
                `Det korrekte ord var: <span class="correct-word">${currentWord.word}</span>.`;
            feedbackEl.className = "incorrect";
        } else if (usedCorrection) {
            feedbackEl.textContent = "Godt! Du skrev ordet korrekt. Nu skal du bruge ordet i en søtning.";
            feedbackEl.className = "correct";
        }

        checkButton.disabled = true;
        showSentenceStep();
    }

    function updateMasteryStats(sentenceStruggle) {
        if (!currentResult) return;

        const info = ensureStats(currentWord.word);
        info.seenCount += 1;
        info.lastSeen = Date.now();
        info.avgAttempts = ((info.avgAttempts * (info.seenCount - 1)) + currentResult.attemptsUsed) / info.seenCount;
        info.lastResult = currentResult.isCorrect ? "correct" : "failed";

        let box = info.box || 1;

        // Spaced repetition (Leitner): promotes on easy success, demotes on struggle.
        if (!currentResult.isCorrect || sentenceStruggle) {
            box = Math.max(1, box - 1);
        } else if (currentResult.attemptsUsed === 1 && !currentResult.hintUsed) {
            box = Math.min(5, box + 1);
        } else if (currentResult.attemptsUsed === 2) {
            box = Math.min(5, box + 1);
        }

        info.box = box;
        const intervalDays = LEITNER_INTERVALS_DAYS[box - 1] || 1;
        info.nextDue = Date.now() + intervalDays * 24 * 60 * 60 * 1000;

        if (currentResult.isCorrect && currentResult.attemptsUsed === 1 && !sentenceStruggle && !currentResult.hintUsed) {
            info.correctCount += 1;
            streakCount += 1;
        } else {
            streakCount = 0;
        }

        saveStats();
        updateMasteryUI();
        updateStreakUI();
    }

    function sentenceIncludesTarget(sentence, target) {
        const normalizedSentence = normalize(sentence);
        const normalizedTarget = normalize(target);
        const pattern = new RegExp(`\\b${escapeRegExp(normalizedTarget)}(e|en|et|er|erne|ene|s)?\\b`, "i");
        return pattern.test(normalizedSentence);
    }

    function escapeRegExp(text) {
        return text.replace(/[.*+?^${}()|[\\]\\]/g, "\\$&");
    }

    async function checkSentenceSpelling(sentence) {
        const params = new URLSearchParams();
        params.set("language", "da-DK");
        params.set("text", sentence);

        const response = await fetch("https://api.languagetool.org/v2/check", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: params.toString()
        });

        if (!response.ok) {
            throw new Error("Stavekontrol mislykkedes.");
        }

        return response.json();
    }

    function splitMatches(matches) {
        const blocking = [];
        const tips = [];
        for (const match of matches || []) {
            if (match.rule && (match.rule.issueType === "misspelling" || match.rule.issueType === "typographical")) {
                blocking.push(match);
            } else {
                tips.push(match);
            }
        }
        return { blocking, tips };
    }

    function renderSentenceErrors(sentence, matches) {
        sentenceErrorsEl.innerHTML = "";
        sentencePreviewEl.textContent = sentence;

        if (!matches || matches.length === 0) {
            return;
        }

        const sorted = [...matches].sort((a, b) => a.offset - b.offset);
        const pieces = [];
        let cursor = 0;

        for (const match of sorted) {
            if (match.offset < cursor) {
                continue;
            }

            pieces.push(escapeHtml(sentence.slice(cursor, match.offset)));
            const word = sentence.substr(match.offset, match.length);
            pieces.push(`<span class="error-word">${escapeHtml(word)}</span>`);
            cursor = match.offset + match.length;

            const li = document.createElement("li");
            li.textContent = match.message;

            const suggestionButtons = document.createElement("div");
            suggestionButtons.className = "suggestion-buttons";
            const suggestions = (match.replacements || []).slice(0, 3);
            suggestions.forEach((item) => {
                const button = document.createElement("button");
                button.type = "button";
                button.textContent = item.value;
                button.addEventListener("click", function () {
                    applySuggestion(match, item.value);
                });
                suggestionButtons.appendChild(button);
            });

            if (suggestions.length) {
                li.appendChild(suggestionButtons);
            }

            sentenceErrorsEl.appendChild(li);
        }

        pieces.push(escapeHtml(sentence.slice(cursor)));
        sentencePreviewEl.innerHTML = pieces.join("");
    }

    function renderSentenceTips(matches) {
        sentenceTipsEl.innerHTML = "";
        for (const match of matches) {
            const li = document.createElement("li");
            li.textContent = match.message;
            sentenceTipsEl.appendChild(li);
        }
    }

    function applySuggestion(match, replacement) {
        const sentence = sentenceInput.value || "";
        const before = sentence.slice(0, match.offset);
        const after = sentence.slice(match.offset + match.length);
        sentenceInput.value = `${before}${replacement}${after}`;
        sentenceFeedbackEl.textContent = "Forslag indsat. Tryk tjek igen.";
        sentenceFeedbackEl.className = "";
        sentencePreviewEl.textContent = sentenceInput.value;
        sentenceErrorsEl.innerHTML = "";
        sentenceTipsEl.innerHTML = "";
        sentenceNextButton.disabled = true;
        sentenceInput.focus();
    }

    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function extractWords(sentence) {
                const matches = sentence.match(/[A-Za-z\u00c6\u00d8\u00c5\u00e6\u00f8\u00e5]+/g) || [];
        return matches.map((word) => word.toLocaleLowerCase("da-DK"));
    }

    async function fetchWiktionaryDefinition(word) {
        if (definitionCache[word]) {
            return definitionCache[word];
        }

        const params = new URLSearchParams();
        params.set("action", "parse");
        params.set("page", word);
        params.set("prop", "wikitext");
        params.set("format", "json");
        params.set("origin", "*");

        const response = await fetch(`https://da.wiktionary.org/w/api.php?${params.toString()}`);
        if (!response.ok) {
            throw new Error("Wiktionary kald mislykkedes.");
        }

        const data = await response.json();
        const wikitext = data && data.parse && data.parse.wikitext
            ? data.parse.wikitext["*"]
            : "";

        if (!wikitext) {
            definitionCache[word] = null;
            saveDefinitionCache();
            return null;
        }

        const definition = extractDanishDefinition(wikitext);
        definitionCache[word] = definition;
        saveDefinitionCache();
        return definition;
    }

    function extractDanishDefinition(wikitext) {
        const lines = wikitext.split("\n");
        let inDanish = false;

        for (const rawLine of lines) {
            const line = rawLine.trim();

            if (
                line.startsWith("{{=da=}}") ||
                line.startsWith("== Dansk ==") ||
                line.startsWith("=={{da}}==") ||
                line.startsWith("== {{da}} ==")
            ) {
                inDanish = true;
                continue;
            }

            if (!inDanish) continue;

            if (line.startsWith("{{=") || /^==[^=]+==/.test(line)) {
                break;
            }

            if (line.startsWith("#")) {
                const cleaned = cleanWikiText(line.replace(/^#+\s*/, ""));
                return cleaned || null;
            }
        }

        return null;
    }

    function cleanWikiText(text) {
        return text
            .replace(/''+/g, "")
            .replace(/\[\[([^|\]]+)\|([^\]]+)\]\]/g, "$2")
            .replace(/\[\[([^\]]+)\]\]/g, "$1")
            .replace(/{{[^}]+}}/g, "")
            .replace(/\s+/g, " ")
            .trim();
    }

    async function updateDefinitions(targetWord, misspellings) {
        if (!settings.showDefinitions) {
            sentenceDefinitionsWrapper.style.display = "none";
            sentenceDefinitionsEl.innerHTML = "";
            return;
        }

        const words = [targetWord, ...misspellings].filter(Boolean);
        const uniqueWords = [...new Set(words)].slice(0, 5);

        sentenceDefinitionsEl.innerHTML = "";
        sentenceDefinitionsWrapper.style.display = "none";

        if (uniqueWords.length === 0) {
            return;
        }

        const loadingItem = document.createElement("li");
        loadingItem.textContent = "Henter forklaringer...";
        sentenceDefinitionsEl.appendChild(loadingItem);
        sentenceDefinitionsWrapper.style.display = "block";

        const definitions = [];
        for (const word of uniqueWords) {
            try {
                const definition = await fetchWiktionaryDefinition(word);
                if (definition) {
                    definitions.push({ word, definition });
                }
            } catch (err) {
            }
        }

        sentenceDefinitionsEl.innerHTML = "";
        if (definitions.length === 0) {
            if (lastDefinitions.length > 0) {
                sentenceDefinitionsWrapper.style.display = "block";
                for (const item of lastDefinitions) {
                    const li = document.createElement("li");
                    li.textContent = `${item.word}: ${item.definition}`;
                    sentenceDefinitionsEl.appendChild(li);
                }
            } else {
                sentenceDefinitionsWrapper.style.display = "none";
            }
            return;
        }

        lastDefinitions = definitions;
        for (const item of definitions) {
            const li = document.createElement("li");
            li.textContent = `${item.word}: ${item.definition}`;
            sentenceDefinitionsEl.appendChild(li);
        }
    }
    answerInput.addEventListener("input", function () {
        currentAnswer = answerInput.value || "";
        renderLetterSlots();
    });

    answerInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            checkButton.click();
        }
    });

    letterSlotsEl.addEventListener("click", function () {
        answerInput.focus();
    });

    window.addEventListener("keydown", function () {
        if (sentenceStepEl.style.display === "block") return;
        if (document.activeElement !== answerInput) {
            answerInput.focus();
        }
    });

    answerForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (!currentWord) return;

        const rawAnswer = currentAnswer || "";
        const user = normalize(rawAnswer);
        const correct = normalize(currentWord.word);

        if (!user) {
            feedbackEl.textContent = "Skriv et ord, før du tjekker.";
            feedbackEl.className = "";
            letterFeedbackEl.innerHTML = "";
            return;
        }

        if (needsCorrection) {
            if (user === correct) {
                finalizeWord(true, rawAnswer, true);
            } else {
                feedbackEl.textContent = "Skriv det korrekte ord for at gå videre.";
                feedbackEl.className = "incorrect";
            }
            return;
        }

        if (user === correct) {
            attemptsEl.textContent = `Forsøg tilbage: ${attemptsLeft}`;
            letterFeedbackEl.innerHTML = "";
            finalizeWord(true, rawAnswer, false);
            return;
        }

        attemptsLeft -= 1;
        attemptsEl.textContent = `Forsøg tilbage: ${attemptsLeft}`;
        feedbackEl.className = "incorrect";
        showDiagnosticFeedback(rawAnswer, currentWord.word);

        if (attemptsLeft <= 0) {
            needsCorrection = true;
            feedbackEl.innerHTML =
                `Du har brugt alle tre forsøg. Det korrekte ord er: ` +
                `<span class="correct-word">${currentWord.word}</span>. ` +
                `Skriv ordet korrekt én gang for at gå videre.`;
            feedbackEl.className = "incorrect";
        }
    });

    sentenceCheckButton.addEventListener("click", async function () {
        if (!currentWord) return;

        const sentence = sentenceInput.value || "";
        const wordCount = sentence.trim().split(/\s+/).filter(Boolean).length;

        sentenceChecks += 1;
        sentenceFeedbackEl.className = "";

        if (wordCount < 4) {
            sentenceFeedbackEl.textContent = "Sætningen skal vøre mindst fire ord.";
            sentenceFeedbackEl.className = "error";
            sentenceNextButton.disabled = true;
            return;
        }

        // Sentence filtering: must contain the target word, case-insensitive, Danish locale.
        if (!sentenceIncludesTarget(sentence, currentWord.word)) {
            sentenceFeedbackEl.textContent = "Sætningen skal indeholde ordet fra staveopgaven.";
            sentenceFeedbackEl.className = "error";
            sentenceNextButton.disabled = true;
            return;
        }

        const now = Date.now();
        if (now - lastSpellcheckTime < 3000) {
            sentenceFeedbackEl.textContent = "Vent et øjeblik før du tjekker igen.";
            sentenceFeedbackEl.className = "error";
            sentenceNextButton.disabled = true;
            return;
        }

        lastSpellcheckTime = now;
        sentenceCheckButton.disabled = true;
        sentenceFeedbackEl.textContent = "Tjekker stavning...";
        sentenceNextButton.disabled = true;
        sentenceErrorsEl.innerHTML = "";
        sentenceTipsEl.innerHTML = "";

        try {
            const result = await checkSentenceSpelling(sentence);
            const matches = result && result.matches ? result.matches : [];
            const { blocking, tips } = splitMatches(matches);

            if (blocking.length) {
                sentenceFeedbackEl.textContent = `Der er ${blocking.length} stavefejl i sætningen.`;
                sentenceFeedbackEl.className = "error";
                sentenceNextButton.disabled = true;
                sentenceHadBlocking = true;
                renderSentenceErrors(sentence, blocking);
            } else {
                sentenceFeedbackEl.textContent = "Sætningen er godkendt.";
                sentenceFeedbackEl.className = "success";
                sentenceNextButton.disabled = false;
                sentenceHadBlocking = false;
                renderSentenceErrors(sentence, []);
            }

            renderSentenceTips(tips);
            const misspellings = blocking.map((match) => sentence.substr(match.offset, match.length));
            lastSentenceMisspellings = misspellings;
            await updateDefinitions(currentWord.word, misspellings);
        } catch (err) {
            sentenceFeedbackEl.textContent = "Stavekontrol er utilgængelig. Du kan fortsætte.";
            sentenceFeedbackEl.className = "success";
            sentenceNextButton.disabled = false;
            sentencePreviewEl.textContent = sentence;
            sentenceErrorsEl.innerHTML = "";
            sentenceTipsEl.innerHTML = "";
            lastSentenceMisspellings = [];
            await updateDefinitions(currentWord.word, []);
        } finally {
            sentenceCheckButton.disabled = false;
        }

        sentenceNextButton.textContent = baseCompleted >= TOTAL_ROUNDS_PER_GAME - 1 ? "Se slutresultat" : "Næste ord";
        sentenceInput.focus();
    });

    sentenceInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sentenceCheckButton.click();
        }
    });

    function handleNextClick() {
        if (!currentResult) return;

        const sentenceStruggle = sentenceChecks > 1 || sentenceHadBlocking;

        updateMasteryStats(sentenceStruggle);

        if (!currentResult.isCorrect || currentResult.attemptsUsed >= 3) {
            scheduleMicroReview(currentWord);
        }

        totalCompleted += 1;
        if (!currentIsBonus) {
            baseCompleted += 1;
        }

        if (baseCompleted >= TOTAL_ROUNDS_PER_GAME && bonusQueue.length === 0 && baseIndex >= baseWords.length) {
            endGame();
            return;
        }

        showCurrentWord();
    }

    sentenceNextButton.addEventListener("click", handleNextClick);

    newGameButton.addEventListener("click", function () {
        startGame();
    });

    function endGame() {
        feedbackEl.className = "";
        feedbackEl.textContent = `Spillet er slut. Du fik ${scoreEl.textContent.replace(/\D/g, "")} point.`;
        letterFeedbackEl.innerHTML = "";
        attemptsEl.textContent = "";
        sentenceStepEl.style.display = "none";
        answerForm.style.display = "flex";
        newGameButton.style.display = "inline-block";
    }

    window.addEventListener("load", startGame);
</script>
</body>
</html>
